---
title: Architecture - Interaction Processing Lifecycle
description: Details the runtime process for handling a single user interaction, using platform context to resolve services and manage the ephemeral scratchpad.
version: 1.1
date: 2025-04-22
parent: ../ARCHITECTURE_PROCESSING_ORCHESTRATION.md
---

# Nucleus OmniRAG: Interaction Processing Lifecycle

## 1. Introduction

This document describes the end-to-end lifecycle of processing a single user interaction within the Nucleus OmniRAG system. This process typically occurs within the containerized compute runtime (e.g., Azure Container Apps, Docker) as outlined in the [Deployment Abstractions](../Deployment/ARCHITECTURE_DEPLOYMENT_ABSTRACTIONS.md#2-asynchronous-messaging-pubsub). It bridges the gap between an external user request arriving via a [Client Adapter](../ClientAdapters/ARCHITECTURE_ADAPTER_INTERFACES.md) and the final response generated by an LLM-powered [Persona](../02_ARCHITECTURE_PERSONAS.md). The core unit of work is represented by an [`IPersonaInteractionContext`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPersonaInteractionContext.cs:0:0-0:0) ([Adapter Interfaces](../ClientAdapters/ARCHITECTURE_ADAPTER_INTERFACES.md#2-ipersonainteractioncontext)).

The key goals of this lifecycle are:
*   **Decoupling:** Separate the initial request intake from the potentially longer-running processing and response generation.
*   **Contextualization:** Gather all necessary information (message content, history, files) required to fulfill the user's request accurately.
*   **Ephemeral Processing:** Perform the work within a temporary context, minimizing persistent state related to a single interaction, aligning with [Security Principles](../06_ARCHITECTURE_SECURITY.md#3-least-privilege--ephemeral-processing).
*   **Efficiency:** Prepare relevant information concisely for the LLM prompt.

## 2. Trigger and Initiation

The interaction lifecycle begins when a processing component (e.g., the [`OrchestrationService`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Processing/Orchestration/OrchestrationService.cs:0:0-0:0) or a dedicated [`PersonaManager`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Processing/Personas/PersonaManager.cs:0:0-0:0)) receives a trigger, typically containing identifiers from a [`NucleusIngestionRequest`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Models/NucleusIngestionRequest.cs:0:0-0:0) originating from an asynchronous messaging **subscription**.

*   **Message Content:** Crucially, the message received typically contains only essential identifiers (e.g., `InteractionId`, `UserId`, source platform message ID, conversation ID) and **not** the potentially sensitive raw message content itself. This aligns with [Security Principles](../06_ARCHITECTURE_SECURITY.md#5-data-minimization).
*   **Adapter Resolution:** The orchestrator uses the `PlatformType` from the [`NucleusIngestionRequest`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Models/NucleusIngestionRequest.cs:0:0-0:0) (or the session's context) to resolve the correct [`IPlatformAdapter`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPlatformAdapter.cs:0:0-0:0) implementation via Dependency Injection (e.g., using keyed services or a factory).

## 3. Context Hydration via Adapter

Using the identifiers (**including `PlatformType`**) and the resolved [`IPlatformAdapter`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPlatformAdapter.cs:0:0-0:0), the orchestrator hydrates the [`IPersonaInteractionContext`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPersonaInteractionContext.cs:0:0-0:0):

*   **Fetch Message Content:** Calling `adapter.GetMessageContentAsync(...)`.
*   **Retrieve Conversation History:** Calling `adapter.GetConversationHistoryAsync(...)`.
*   **Access Artifacts:** If `SourceArtifactUris` are present, **and if the Persona logic requires the original artifact content during processing (not for initial analysis)**, the orchestrator uses the `PlatformType` and `ContentSourceUri` from the *original request* to resolve the specific [`IPlatformAttachmentFetcher`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPlatformAttachmentFetcher.cs:0:0-0:0) and invoke it.

## 4. Ephemeral Markdown Scratchpad

Once the initial context is hydrated, the orchestrator (or [`PersonaManager`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Processing/Personas/PersonaManager.cs:0:0-0:0)) ensures the `EphemeralMarkdownScratchpad` exists for the session.

*   **Location:** Ephemeral local storage (e.g., `/tmp/{SessionId}.md`).
*   **Purpose:** Short-term working memory for the current interaction and session.
*   **Content:** Contains structured snippets and metadata including:
    *   Session ID, Canonical Persona ID, Platform User ID Map, Conversation ID, Origin Platform, Current Platform Context, etc. (See [Routing Doc](./ARCHITECTURE_ORCHESTRATION_ROUTING.md#4-ephemeral-markdown-scratchpad-structure)).
    *   Key phrases/summaries from history.
    *   Extracted text/summaries from artifacts **fetched via [`IPlatformAttachmentFetcher`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPlatformAttachmentFetcher.cs:0:0-0:0) if needed by the Persona**.
    *   Relevant results from internal vector searches.
    *   The current user message being processed.
    *   Persona's draft response/analysis state.

## 5. LLM Prompt Assembly & Invocation

The orchestrator constructs the final prompt for the AI Service, including:

*   User request.
*   System instructions.
*   Relevant context synthesized from the **up-to-date** ephemeral markdown scratchpad.

The orchestrator invokes the AI service API.

## 6. Response Delivery & Cleanup

Upon receiving the generated response from the LLM:

1.  **Resolve Notifier:** The orchestrator determines the target `PlatformType` (usually the `CurrentPlatformContext` from the scratchpad, or explicitly specified for persona-to-persona messages). It uses this `PlatformType` to resolve the correct [`IPlatformNotifier`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Abstractions/Interfaces/IPlatformNotifier.cs:0:0-0:0) implementation via DI.
2.  **Get Target Details:** It retrieves the necessary platform-specific target identifiers (e.g., user ID, channel ID, email address) from the scratchpad's `PlatformUserIdMap` or the session context.
3.  **Deliver Response:** The orchestrator calls `notifier.SendNotificationAsync(responseContent, targetDetails)` on the resolved notifier.
4.  **(Potentially Update Scratchpad):** Record the outgoing message in the scratchpad's history.
5.  **Cleanup (Session End):** When the interaction session is deemed complete (e.g., after a period of inactivity managed by the [`PersonaManager`](cci:2://file:///d:/Projects/Nucleus/Nucleus.Processing/Personas/PersonaManager.cs:0:0-0:0)), the `EphemeralMarkdownScratchpad` **must** be explicitly deleted. This cleanup is critical.
6.  **Dispose Context:** Related resources are released.

This completes the lifecycle for processing a single user interaction, ensuring context is gathered, processed ephemerally, used for generation, and cleaned up securely. This flow is central to the overall [Processing Architecture](../05_ARCHITECTURE_PROCESSING.md).