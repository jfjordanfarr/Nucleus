---
title: "Ingestion Architecture - Plaintext Files (M365/MCP)"
description: "Describes the handling of raw text or text outputs from other processors, orchestrated by M365 Persona Agents and executed by backend MCP Tools."
version: 2.1
date: 2025-05-26
parent: ../ARCHITECTURE_PROCESSING_INGESTION.md
---

# Ingestion Architecture: Plaintext Files (M365/MCP)

## 1. Role and Overview

The Plaintext File processing capability is a core function within the ingestion pipeline ([`ARCHITECTURE_PROCESSING_INGESTION.md`](../ARCHITECTURE_PROCESSING_INGESTION.md)), now orchestrated by **Microsoft 365 Persona Agents** and executed by the backend **`Nucleus_ContentProcessing_McpServer` (an MCP Tool)**. It handles textual data from various sources:

*   Naturally text-based files (e.g., `.txt`, `.md`, `.csv`, `.json`, `.xml`, source code files) accessed via the **`Nucleus_FileAccess_McpServer` (an MCP Tool)**.
*   The textual output streams generated by other processing functions within the `Nucleus_ContentProcessing_McpServer` (e.g., LLM-generated image descriptions from multimedia processing, audio transcriptions, text extracted from PDF/Office documents, raw XML from Office files).

Its core responsibility is to **convert the incoming textual data into a canonical, structured ephemeral Markdown representation**. This final Markdown output is then **returned to the orchestrating M365 Persona Agent** for its own analysis, salient knowledge extraction, and subsequent storage via the `Nucleus_KnowledgeStore_McpServer`.

## 2. Actors and Flow

*   **Orchestrator:** **Microsoft 365 Persona Agent**
    *   Determines the need for plaintext processing based on an event (e.g., file share in Teams, email attachment).
    *   Invokes the `Nucleus_FileAccess_McpServer` (MCP Tool) to retrieve the raw file content if necessary.
    *   Invokes the `Nucleus_ContentProcessing_McpServer` (MCP Tool) (specifically its plaintext processing capabilities) with the textual data.
*   **File Content Provider:** **`Nucleus_FileAccess_McpServer` (MCP Tool)**
    *   Provides raw file content (text streams) to the `Nucleus_ContentProcessing_McpServer` (MCP Tool) or directly to the M365 Persona Agent, as orchestrated.
*   **Text Processor:** **`Nucleus_ContentProcessing_McpServer` (MCP Tool)**
    *   Receives textual data (from `Nucleus_FileAccess_McpServer` or directly from the M365 Persona Agent if the text is already available, e.g., from a message).
    *   Performs conversion/synthesis to structured Markdown.
    *   Returns the ephemeral Markdown to the M365 Persona Agent.
*   **Consumer of Ephemeral Markdown:** **Microsoft 365 Persona Agent**
    *   Receives the structured Markdown from `Nucleus_ContentProcessing_McpServer` (MCP Tool).
    *   Performs its persona-specific analysis, intelligence extraction, and decides what knowledge to store.
    *   Invokes the `Nucleus_KnowledgeStore_McpServer` (MCP Tool) to persist `ArtifactMetadata` and `PersonaKnowledgeEntry` records.

## 3. Processing Steps

1.  **Initiation (M365 Persona Agent):**
    *   An M365 Persona Agent is triggered by a platform event (e.g., a `.txt` file shared in a Teams chat).
    *   The Agent determines that plaintext processing is required.
2.  **Content Retrieval (M365 Persona Agent via `Nucleus_FileAccess_McpServer`):**
    *   The M365 Persona Agent calls the `Nucleus_FileAccess_McpServer` (MCP Tool) to get the content of the text file.
3.  **Text Processing Request (M365 Persona Agent to `Nucleus_ContentProcessing_McpServer` (MCP Tool)):**
    *   The M365 Persona Agent sends the retrieved text content (or text from other sources like message bodies) to the `Nucleus_ContentProcessing_McpServer` (MCP Tool), requesting conversion to Markdown. This can be:
        *   A single text stream or string with format hints (e.g., `source=xml`).
        *   A bundle of multiple related text streams/strings (e.g., XML components + LLM descriptions from an unpacked [File Collection](./ARCHITECTURE_INGESTION_FILECOLLECTIONS.md)) along with a **synthesis instruction** (e.g., "Synthesize a coherent Markdown document from these components representing the original source artifact").
4.  **Convert/Synthesize to Structured Markdown (`Nucleus_ContentProcessing_McpServer` (MCP Tool)):**
    *   **Single Input:** If receiving a single input, the `Nucleus_ContentProcessing_McpServer` (MCP Tool) converts it to Markdown (e.g., using libraries or an internal LLM call for complex formatting).
    *   **Bundle Input (Synthesis):** If receiving a bundle and a synthesis instruction:
        *   The `Nucleus_ContentProcessing_McpServer` (MCP Tool) constructs a large prompt for its configured LLM (e.g., Gemini).
        *   Includes the synthesis instruction, all provided textual components (XMLs, descriptions, etc.), and any relevant context (original container filename, etc.).
        *   Invokes the LLM, relying on its large context window and common-sense reasoning to interpret the relationships between the components (e.g., OOXML structure) and generate **one single, coherent, well-structured Markdown document** representing the original artifact.
5.  **Minimal Cleanup (Optional) (`Nucleus_ContentProcessing_McpServer` (MCP Tool)):** Perform final normalization on the generated/synthesized Markdown.
6.  **Return Ephemeral Markdown (to M365 Persona Agent):** The `Nucleus_ContentProcessing_McpServer` (MCP Tool) returns the generated, canonical Markdown content (as a string or stream) to the calling M365 Persona Agent.
7.  **Persona Analysis & Knowledge Storage (M365 Persona Agent):**
    *   The M365 Persona Agent consumes the ephemeral Markdown.
    *   It performs its persona-specific analysis (e.g., identifying key learning points for `EduFlow`, extracting relevant business facts for `ProfessionalColleague`).
    *   It then calls the `Nucleus_KnowledgeStore_McpServer` (MCP Tool) to create/update `ArtifactMetadata` and `PersonaKnowledgeEntry` records based on its analysis. The original file content and the ephemeral Markdown are **not** stored by the `Nucleus_KnowledgeStore_McpServer` (MCP Tool).

## 4. Key Principles

*   **Orchestration by M365 Persona Agent:** The M365 Agent drives the process, calling specialized backend MCP Tools.
*   **Canonical Format = Markdown:** The `Nucleus_ContentProcessing_McpServer` (MCP Tool)'s output is *always* structured Markdown.
*   **Ephemeral Output (from MCP Tool):** The Markdown generated by `Nucleus_ContentProcessing_McpServer` (MCP Tool) is transient and consumed by the M365 Persona Agent.
*   **No Chunking (by MCP Tool):** The final ephemeral Markdown output is passed *whole* from the `Nucleus_ContentProcessing_McpServer` (MCP Tool) to the M365 Persona Agent. The Agent then decides on relevant snippets for its `PersonaKnowledgeEntry`.
*   **No Embedding (by MCP Tool):** Vector embeddings are not generated by the `Nucleus_ContentProcessing_McpServer` (MCP Tool). Embedding generation is handled by the `Nucleus_KnowledgeStore_McpServer` (MCP Tool) based on the `PersonaKnowledgeEntry` data provided by the M365 Persona Agent.
*   **No Semantic Interpretation (by MCP Tool for Formatting):** While `Nucleus_ContentProcessing_McpServer` (MCP Tool) restructures text into Markdown (potentially using an LLM for complex synthesis), its primary goal is formatting, not deep semantic analysis for knowledge extraction. The M365 Persona Agent performs the semantic interpretation.
*   **Idempotency:** Given the same input text and format hint, the `Nucleus_ContentProcessing_McpServer` (MCP Tool) should consistently produce the same Markdown output. The M365 Persona Agent determines if processing is needed based on source identifiers and its own state.

This updated flow ensures that all ingested textual information is normalized into a consistent, high-quality Markdown format by a dedicated MCP Tool, providing a standardized foundation for the M365 Persona Agent's subsequent analysis, intelligent snippet extraction, and knowledge storage.
