---
title: Architecture - Database (Azure Cosmos DB)
description: Details the Azure Cosmos DB structure for storing ArtifactMetadata and PersonaKnowledgeEntry records.
version: 2.2
date: 2025-04-24
---

# Nucleus OmniRAG: Database Architecture (Azure Cosmos DB)

**Version:** 2.2
**Date:** 2025-04-24

This document details the architecture of the backend database used by Nucleus OmniRAG, utilizing Azure Cosmos DB for NoSQL, as introduced in the [System Architecture Overview](./00_ARCHITECTURE_OVERVIEW.md). Cosmos DB serves as the central persistence layer for **all** Nucleus-managed metadata, including both the primary **`ArtifactMetadata`** records describing source artifacts (see [Storage Architecture](./03_ARCHITECTURE_STORAGE.md)) and the **`PersonaKnowledgeEntry`** records containing persona-specific analysis (see [Persona Architecture](./02_ARCHITECTURE_PERSONAS.md)).

## 1. Core Principle: Centralized Metadata in Cosmos DB

Cosmos DB's role is to provide a highly performant, scalable store for all structured metadata Nucleus generates and manages.

*   **`ArtifactMetadata` Store:** Holds the central, factual records *about* each source artifact encountered (defined in [Storage Architecture](./03_ARCHITECTURE_STORAGE.md)).
*   **`PersonaKnowledgeEntry` Stores:** Holds the *interpretations* and analyses of artifacts generated by specific [Personas](./02_ARCHITECTURE_PERSONAS.md).

This approach keeps all queryable metadata within a single, manageable database system, while the actual artifact content remains in the user's source system (accessed via [Adapters/Clients](./05_ARCHITECTURE_CLIENTS.md)).

## 2. Database Structure

The Cosmos DB database contains multiple containers:

*   **`ArtifactMetadataContainer` (Recommended Name):**
    *   **Purpose:** Stores all `ArtifactMetadata` documents.
    *   **Partition Key:** Likely `tenantId` (for multi-tenant/self-hosted) or potentially `userId` if strictly single-user focus, or even a synthetic key depending on query patterns across users/tenants.
*   **`{PersonaId}KnowledgeContainer` (One per Persona):**
    *   **Naming Convention:** e.g., `EduFlow_v1KnowledgeContainer`, `BusinessAssistant_v1KnowledgeContainer`.
    *   **Purpose:** Each container holds all `PersonaKnowledgeEntry` documents generated by that specific persona.
    *   **Partition Key:** Typically `userId` (for Cloud-Hosted, user-scoped queries) or `tenantId` (for Self-Hosted, tenant-scoped queries).

## 3. `ArtifactMetadataContainer` Schema

Each document stored within the `ArtifactMetadataContainer` follows the [`ArtifactMetadata`](../../../Nucleus.Abstractions/Models/ArtifactMetadata.cs) record definition.

*   **Key Fields:** `id` (Cosmos Document ID), `sourceIdentifier` (logical key), `sourceUri`, `sourceSystemType`, `displayName`, timestamps, authorship, relationships, processing status (`overallProcessingState`, `personaProcessingStatus`), etc.

## 4. `{PersonaId}KnowledgeContainer` Schema

Each document stored within a persona-specific container follows the [`PersonaKnowledgeEntry<TAnalysisData>`](../../../Nucleus.Abstractions/Repositories/IPersonaKnowledgeRepository.cs) structure (defined in the same file as its repository interface), representing that persona's interpretation of a source artifact.

*   **Document Example (`EduFlow_v1KnowledgeContainer` storing `PersonaKnowledgeEntry<EduFlowAnalysis>`):
    ```json
    {
        "id": "unique-pke-guid", // Cosmos DB Document ID for this PersonaKnowledgeEntry
        "userId": "user-guid-or-identifier",     // Partition Key (Cloud-Hosted)
        // "tenantId": "tenant-guid-or-identifier", // Partition Key Alt (Self-Hosted)
        "sourceIdentifier": "spo://...Q1_Report.docx?ver=1", // Links to the ArtifactMetadata document (matches its sourceIdentifier)
        "sourceSegmentIdentifier": null, // Optional: Identifier for a sub-part of the source artifact
        "personaName": "EduFlow_v1", // Explicitly states the generating persona
        "relevantTextSnippetOrSummary": "EduFlow decided this text was most relevant: Learner shows understanding of algebraic equations...", // Persona-extracted/generated text snippet or summary, max length enforced!
        "snippetEmbedding": [0.12, -0.05, ...], // Vector embedding of relevantTextSnippetOrSummary
        "analysis": { // Persona-specific structured analysis object (TAnalysisData)
            // Example for EduFlowAnalysis:
            "analysisTimestamp": "2025-04-08T03:00:00Z",
            "modelVersion": "gemini-1.5-pro-latest",
            "confidenceLevel": "High",
            "summary": "Learner demonstrates proficiency in solving linear equations but struggles with quadratic formulas.",
            "suggestedSkillIds": ["skill-algebra-linear", "skill-problem-solving"],
            "potentialMisconceptions": "Confuses quadratic formula terms."
            // ... other EduFlowAnalysis specific fields
        },
        // Optional: Embedding of a derived summary from the analysis object itself
        // "analysisSummaryEmbedding": [-0.08, 0.25, ...],
        "relatedSourceIdentifiers": ["spo://.../Q1_Data.xlsx?ver=3"], // Links to other ArtifactMetadata suggested by the persona
        "timestampCreated": "2025-04-08T03:05:00Z", // When this PKE was created
        "timestampLastUpdated": "2025-04-08T03:05:00Z", // When this PKE was last updated
        "_ts": 1678722600 // Cosmos DB Timestamp
    }
    ```

### 4.1 C# Model: `PersonaKnowledgeEntry<TAnalysisData>`

```csharp
using System.Text.Json.Serialization;

/// <summary>
/// Enum representing the confidence level of the persona's analysis.
/// </summary>
public enum ConfidenceLevel
{
    Unknown = 0,
    VeryLow = 1,
    Low = 2,
    Medium = 3,
    High = 4,
    VeryHigh = 5
}

/// <summary>
/// Represents a specific piece of knowledge or analysis generated by a Persona,
/// linked to a specific source artifact or segment. This captures what a persona knows about that source/segment.
/// </summary>
/// <typeparam name="TAnalysisData">The CLR type of the persona-specific analysis payload.</typeparam>
public record PersonaKnowledgeEntry<TAnalysisData>(
    [property: JsonPropertyName("id")] string id, // Primary Key (Document ID)
    string userId, // Typically used as Partition Key (Cloud-Hosted)
    string sourceIdentifier, // Foreign Key linking to the ArtifactMetadata document (matches its sourceIdentifier)
    string? sourceSegmentIdentifier, // Optional: Identifier for a sub-part of the source artifact
    string personaName, // Name/Version of the persona that generated this entry
    string relevantTextSnippetOrSummary, // The specific text snippet/summary identified by the persona
    Embedding<float> snippetEmbedding, // Vector embedding of the relevantTextSnippetOrSummary
    TAnalysisData analysis, // The structured analysis payload specific to the persona (must include ConfidenceLevel)
    Embedding<float>? analysisSummaryEmbedding, // Optional: Embedding of a derived summary from the analysis
    List<string>? relatedSourceIdentifiers, // Optional: Links to other related ArtifactMetadata records
    DateTimeOffset timestampCreated,
    DateTimeOffset timestampLastUpdated,
    string? tenantId // Optional: Partition Key alternative (Self-Hosted)
)
{
    // Explicit property for Cosmos SDK partition key path mapping if needed
    // Adjust logic based on hosting model
    [JsonIgnore]
    public string PartitionKey => tenantId ?? userId;
}

## 5. Integration with Other Architectures

### 5.1 Processing (`01_ARCHITECTURE_PROCESSING.md`)
*   The **`Nucleus.Services.Api` orchestrates** the processing pipeline.
*   Upon receiving an interaction/trigger (potentially relayed by an adapter), the API service initiates the pipeline.
*   The pipeline logic, operating within the API service context, uses the **`IArtifactMetadataRepository`** to create/update `ArtifactMetadata` in `ArtifactMetadataContainer`.
*   It instructs Personas (also within the API service context) to analyze content (fetched via adapters, as directed by the API service).
*   It receives `PersonaKnowledgeEntry` data from Personas.
*   It uses the **`IPersonaKnowledgeRepository<TAnalysisData>`** to store `PersonaKnowledgeEntry` in the appropriate `{PersonaId}KnowledgeContainer`.
*   Pipeline updates the `personaProcessingStatus` dictionary within the relevant `ArtifactMetadata` document in Cosmos DB (again, via the `IArtifactMetadataRepository`).

### 5.2 Personas (`02_ARCHITECTURE_PERSONAS.md`)

*   **Analysis:** Personas (implementing [`IPersona`](../../../Nucleus.Abstractions/IPersona.cs)) receive artifact content streams, perform analysis, and return the `analysis` object and `relevantTextSnippetOrSummary` to the pipeline.
*   **Retrieval for Querying/Reporting (RAG):**
    *   A persona queries **its own** `{PersonaId}KnowledgeContainer` in Cosmos DB.
    *   It performs vector searches against `snippetEmbedding` or `analysisSummaryEmbedding`.
    *   Field projection retrieves necessary fields (`id`, `relevantTextSnippetOrSummary`, `analysis`, `sourceIdentifier`, etc.).
    *   If needed, the persona can use the `sourceIdentifier` from a retrieved PKE to request the full `ArtifactMetadata` (from `ArtifactMetadataContainer`) or even fresh content from the source system via adapters (using `sourceUri`) for more context. **This request for fresh content is mediated by the `Nucleus.Services.Api`, which instructs the appropriate adapter.**

### 5.3 Storage (`03_ARCHITECTURE_STORAGE.md`)

*   The [Storage Architecture](./03_ARCHITECTURE_STORAGE.md) document (`03_ARCHITECTURE_STORAGE.md`) primarily defines the **logical structure of the `ArtifactMetadata` object**, which is persisted within the `ArtifactMetadataContainer` in Cosmos DB.
*   It clarifies that artifact *content* resides externally in user source systems, accessed via [Adapters](./05_ARCHITECTURE_CLIENTS.md).

## 6. Scalability and Performance

*   **Partitioning:** Proper partition key selection (`userId`, `tenantId`, or other) is crucial for distributing load and enabling efficient queries within both `ArtifactMetadataContainer` and `{PersonaId}KnowledgeContainer`s. The choice impacts cost and scalability and is influenced by the [Deployment Model](./07_ARCHITECTURE_DEPLOYMENT.md) (e.g., cloud-hosted multi-tenant vs. self-hosted single-tenant) and [Security](./06_ARCHITECTURE_SECURITY.md) requirements.
*   **Vector Search:** Integrated Vector Database capabilities in Cosmos DB enable efficient similarity searches within each persona's container.
*   **Indexing:** Appropriate indexing policies (beyond vector indexes) are needed for efficient metadata filtering (see [Security considerations](./06_ARCHITECTURE_SECURITY.md) regarding what gets indexed).
*   **Throughput:** RU/s need to be provisioned appropriately for the database or individual containers based on expected load (see [Deployment Architecture](./07_ARCHITECTURE_DEPLOYMENT.md) for cost implications).

## 7. Next Steps

1.  **Implement C# Models:** Define concrete `TAnalysisData` types (e.g., `EduFlowAnalysis`, `ProfessionalAnalysis`) for each persona within the [`Nucleus.Abstractions`](../../../Nucleus.Abstractions/) project or a dedicated `Nucleus.Personas.Abstractions` project.
2.  **Implement Repository Layer:** Develop concrete implementations (likely within `Nucleus.Services.Api`) for the defined [`IArtifactMetadataRepository`](../../../Nucleus.Abstractions/Repositories/IArtifactMetadataRepository.cs) and [`IPersonaKnowledgeRepository<TAnalysisData>`](../../../Nucleus.Abstractions/Repositories/IPersonaKnowledgeRepository.cs) interfaces using the Cosmos DB .NET SDK. Ensure dynamic container handling for PKEs.
3.  **Define Partition Key Strategy:** Finalize the partition key choices for both container types based on [deployment models](./07_ARCHITECTURE_DEPLOYMENT.md) and query patterns.
4.  **Provision Cosmos DB:** Set up the Cosmos DB account, database, and define container creation/configuration strategy (part of [Deployment](./07_ARCHITECTURE_DEPLOYMENT.md)).
5.  **Integrate with Processing Pipeline:** Update the [pipeline](./01_ARCHITECTURE_PROCESSING.md) (orchestrated by the API service) to implement the flow described in Section 5.1, utilizing the repository implementations.

---

_This architecture document specifies the Cosmos DB structure, clarifying its role as the central store for both factual `ArtifactMetadata` and interpretive `PersonaKnowledgeEntry` data, linking them via the `sourceIdentifier`._
