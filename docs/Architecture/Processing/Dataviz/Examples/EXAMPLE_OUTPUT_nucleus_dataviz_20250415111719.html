<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nucleus Dataviz</title>
    <script src='https://cdn.plot.ly/plotly-2.32.0.min.js'></script> <!-- Updated Plotly library version -->
    <!-- Prism JS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- Basic Styles - Give plot area dimensions initially -->
    <style>
        #plot-area {
            /* display: none; */ /* Removed - Let JS handle visibility */
            width: 100%;   /* Ensure it takes up width */
            min-height: 450px; /* Give it a default minimum height */
            background-color: #fff; /* Optional: visual aid during debugging */
            border: 1px solid #ccc; /* Optional: visual aid */
        }
        /* Existing CSS rules can go here or be loaded via {{STYLES_PLACEHOLDER}} */
    </style>
    <style>
/* BRANDING_CSS_PLACEHOLDER */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f4f4f4;
    color: #333;
}
h1 {
    color: #005a9e; /* A corporate blue */
    text-align: center;
    border-bottom: 2px solid #005a9e;
    padding-bottom: 10px;
}
#loading-indicator, #error-area {
    text-align: center;
    margin-top: 50px;
    font-style: italic;
    color: #666;
}
#error-area {
    color: #d9534f; /* Bootstrap danger red */
    font-weight: bold;
    white-space: pre-wrap; /* Preserve error formatting */
}

#error-area {
    display: none;
    color: red;
    border: 1px solid red;
    padding: 10px;
    margin-top: 10px;
}

#output-area {
    margin-top: 20px;
    padding: 15px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    /* Use viewport height - adjust 70vh as needed */
    height: 70vh;
    overflow: auto; /* Add scrollbars if content exceeds height */
    resize: vertical; /* Optional: allow user resizing */
    display: flex; /* Use flexbox to help child sizing */
    flex-direction: column; /* Stack children vertically */
}

/* Make Plotly div take available space */
#output-area .plotly-graph-div {
    flex-grow: 1; /* Allow plot div to grow */
    min-height: 0; /* Override any potential default min-height interfering with flex-grow */
}
#export-buttons {
    text-align: center;
    margin-top: 15px;
}

#export-buttons {
    display: none;
    margin-top: 15px;
}

button {
    background-color: #5cb85c; /* Bootstrap success green */
    color: white;
    border: none;
    padding: 8px 15px;
    margin: 5px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
button:hover {
    background-color: #4cae4c;
}
button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

#view-worker-log {
    display: none; /* Initially hidden */
}

#plot-area {
    /* display: none; */ /* Initially hidden by JS */
    border: 1px solid #ccc;
    margin-top: 10px; /* Reduced margin */
    width: 100%;
    /* height: 600px; REMOVED fixed height */
    box-sizing: border-box;
    flex-grow: 1; /* Allow plot area to grow vertically in flex container */
    min-height: 0; /* Prevent flexbox sizing issues */
    position: relative; /* Ensure Plotly positions correctly within */
}

/* Modal Styles (Shared class for common styles) */
.modal-overlay {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1000; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
}

.modal-dialog {
    background-color: #fefefe;
    margin: 5% auto; /* 5% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
    height: 80%; /* Allow space around */
    position: relative;
    display: flex; /* Use flexbox for layout */
    flex-direction: column; /* Stack elements vertically */
}

.modal-dialog-header {
     padding-bottom: 10px;
     border-bottom: 1px solid #ccc;
     margin-bottom: 15px;
     display: flex;
     justify-content: space-between; /* Push title and close button apart */
     align-items: center;
}

 .modal-dialog-title {
     font-size: 1.2em;
     font-weight: bold;
     margin-right: auto; /* Push title left */
 }

.modal-copy-button {
    background-color: #eee;
    border: 1px solid #ccc;
    padding: 3px 8px;
    font-size: 0.8em;
    cursor: pointer;
    margin-left: 15px; /* Space from title/close */
}

.modal-dialog-close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    padding: 0 5px; /* Easier to click */
    line-height: 1;
}

.modal-dialog-close:hover,
.modal-dialog-close:focus {
    color: black;
    text-decoration: none;
}

.modal-dialog-body {
    flex-grow: 1; /* Allow body to take up remaining space */
    overflow: auto; /* Add scrollbars to the code area if needed */
    background-color: #f0f0f0; /* Light grey background for code */
    border: 1px solid #ddd;
}

 .modal-dialog-body pre {
    margin: 0; /* Remove default pre margin */
    padding: 10px; /* Add some padding inside */
}

/* Worker Log Modal Styles (copying structure from code/data modals) */
#worker-log-modal .modal-dialog-body code {
     font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; /* Ensure monospace */
     font-size: 0.9em;
     /* Color will be handled by Prism theme */
}

.modal-copy-button:active {
    background-color: #d4d4d4; /* Slight visual feedback on click */
}

</style> <!-- Placeholder for other CSS -->
</head>
<body>
    <h1>Interactive Visualization</h1>

    <div id="loading-indicator">
        Loading Visualization Engine (Pyodide)... This may take a moment.
    </div>
    <div id="error-area"></div>
    <div id="output-area">
        <!-- Plotly or Matplotlib output will be injected here -->
        <div id="plot-area"></div> <!-- Removed inline style="display: none;" -->
    </div>
    <div id="export-buttons">
        <button id="export-png" disabled>Export PNG</button>
        <button id="export-svg" disabled>Export SVG</button>
        <button id="export-html" disabled>Export HTML</button>
        <button id="view-python-code">View Python Code</button>
        <button id="view-data">View Data</button>
        <button id="view-worker-log">View Worker Log</button>
    </div>

    <!-- Code Viewer Modal -->
    <div id="code-modal" class="modal-overlay">
        <div class="modal-dialog">
           <div class="modal-dialog-header">
               <span class="modal-dialog-title">Python Script Content</span>
               <button id="copy-python-button" class="modal-copy-button">Copy</button>
               <span id="close-modal" class="modal-dialog-close" onclick="document.getElementById('code-modal').style.display='none'">&times;</span>
           </div>
           <div class="modal-dialog-body">
               <pre><code id="python-code-display" class="language-python"># === START OF PYTHON SCRIPT ===
import plotly.express as px
import pandas as pd
import io
import json

# Read the JSON data passed from the main script
# This assumes the data is available in a variable or fetched appropriately
# In this template setup, it will be provided via pyodide.runPythonAsync
# The &#39;input_data_json&#39; variable will be injected by the worker script
data = json.loads(input_data_json)
df = pd.DataFrame(data)

# Generate the plot
# Use the actual column names from the input data
fig = px.scatter(df, x=&quot;x_col&quot;, y=&quot;y_col&quot;, title=&quot;Scatter Plot from Python&quot;) # Modified column names

# Update the layout
fig.update_layout(
    title=&#39;Scatter Plot from Python (Plotly)&#39;,
    xaxis_title=&#39;X Axis&#39;,
    yaxis_title=&#39;Y Axis&#39;,
    margin=dict(l=40, r=40, t=40, b=40),
    autosize=True  # Enable autosizing
)

# Convert the plot to JSON
graph_json = fig.to_json()

# Return the JSON string (this will be the output of pyodide.runPythonAsync)
graph_json
# === END OF PYTHON SCRIPT ===
</code></pre>
           </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div id="data-modal" class="modal-overlay">
        <div class="modal-dialog">
           <div class="modal-dialog-header">
               <span class="modal-dialog-title">Input JSON Data</span>
               <button id="copy-data-button" class="modal-copy-button">Copy</button>
               <span id="close-data-modal" class="modal-dialog-close" onclick="document.getElementById('data-modal').style.display='none'">&times;</span>
           </div>
           <div class="modal-dialog-body">
               <!-- Data will be loaded by JS -->
               <pre><code id="json-data-display" class="language-json"></code></pre>
           </div>
        </div>
    </div>

     <!-- Worker Log Viewer Modal -->
    <div id="worker-log-modal" class="modal-overlay">
        <div class="modal-dialog">
           <div class="modal-dialog-header">
               <span class="modal-dialog-title">Worker Console Log</span>
                <button id="copy-worker-log-button" class="modal-copy-button">Copy</button>
               <span id="close-worker-log-modal" class="modal-dialog-close" onclick="document.getElementById('worker-log-modal').style.display='none'">&times;</span>
           </div>
           <div class="modal-dialog-body">
               <pre><code id="worker-log-display" class="language-log"></code></pre>
           </div>
        </div>
    </div>

    <!-- Embedded Data Placeholder -->
    <script id="input-data" type="application/json">
        {&quot;x_col&quot;: [1, 2, 3, 4, 5], &quot;y_col&quot;: [10, 11, 12, 13, 14]}
    </script>

    <!-- Embedded Worker Script Placeholder -->
    <script id="worker-script-template" type="text/plain">
        // dataviz-worker.js
// Import Pyodide - adjust the version if needed
importScripts(&quot;https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js&quot;);

let pyodide = null;
let pyodideLoadingPromise = null;

async function initializePyodide() {
  if (pyodide) {
    return pyodide;
  }
  if (pyodideLoadingPromise) {
    return pyodideLoadingPromise;
  }

  console.log(&quot;Worker: Initializing Pyodide...&quot;);
  pyodideLoadingPromise = loadPyodide({
    // indexURL: &quot;https://cdn.jsdelivr.net/pyodide/v0.25.1/full/&quot; // Optional: specify indexURL if needed
  }).then(async (instance) =&gt; {
    pyodide = instance;
    console.log(&quot;Worker: Pyodide initialized. Loading micropip...&quot;);
    await pyodide.loadPackage(&quot;micropip&quot;);
    const micropip = pyodide.pyimport(&quot;micropip&quot;);
    console.log(&quot;Worker: Micropip loaded. Loading pandas and plotly...&quot;);
    await micropip.install([&#39;pandas&#39;, &#39;plotly&#39;]);
    console.log(&quot;Worker: pandas and plotly loaded.&quot;);
    self.postMessage({ type: &#39;status&#39;, message: &#39;Pyodide and packages ready.&#39; });
    pyodideLoadingPromise = null; // Reset promise after successful load
    return pyodide;
  }).catch(error =&gt; {
     console.error(&quot;Worker: Pyodide initialization failed:&quot;, error);
     self.postMessage({ type: &#39;error&#39;, message: `Pyodide initialization failed: ${error.message}` });
     pyodideLoadingPromise = null; // Reset promise on error
     throw error; // Re-throw error to indicate failure
  });
  return pyodideLoadingPromise;
}

// Handle messages from the main thread
self.onmessage = async (event) =&gt; {
  const { pythonScript, inputData } = event.data;

  try {
    // Ensure Pyodide is initialized
    await initializePyodide();

    if (!pyodide) {
        throw new Error(&quot;Pyodide is not available after initialization attempt.&quot;);
    }

    console.log(&quot;Worker: Received task. Running Python script...&quot;);
    self.postMessage({ type: &#39;status&#39;, message: &#39;Running Python script...&#39; });

    // Inject data into the Python environment
    pyodide.globals.set(&#39;input_data_json&#39;, JSON.stringify(inputData));

    // Run the Python script
    const result = await pyodide.runPythonAsync(pythonScript);

    console.log(&quot;Worker: Python script finished. Sending result.&quot;);
    // Send the result back to the main thread
    self.postMessage({ type: &#39;result&#39;, data: result });

  } catch (error) {
    console.error(&quot;Worker: Error executing Python script:&quot;, error);
    self.postMessage({ type: &#39;error&#39;, message: error.message });
  }
};

// Initial message to confirm worker is loaded (optional)
console.log(&quot;Worker: Script loaded. Waiting for initialization trigger.&quot;);
// Trigger initialization immediately upon loading the worker script.
initializePyodide();

    </script>

    <!-- Embedded Python Script Placeholder -->
    <script id="python-script-template" type="text/plain">
        # === START OF PYTHON SCRIPT ===
import plotly.express as px
import pandas as pd
import io
import json

# Read the JSON data passed from the main script
# This assumes the data is available in a variable or fetched appropriately
# In this template setup, it will be provided via pyodide.runPythonAsync
# The &#39;input_data_json&#39; variable will be injected by the worker script
data = json.loads(input_data_json)
df = pd.DataFrame(data)

# Generate the plot
# Use the actual column names from the input data
fig = px.scatter(df, x=&quot;x_col&quot;, y=&quot;y_col&quot;, title=&quot;Scatter Plot from Python&quot;) # Modified column names

# Update the layout
fig.update_layout(
    title=&#39;Scatter Plot from Python (Plotly)&#39;,
    xaxis_title=&#39;X Axis&#39;,
    yaxis_title=&#39;Y Axis&#39;,
    margin=dict(l=40, r=40, t=40, b=40),
    autosize=True  # Enable autosizing
)

# Convert the plot to JSON
graph_json = fig.to_json()

# Return the JSON string (this will be the output of pyodide.runPythonAsync)
graph_json
# === END OF PYTHON SCRIPT ===

    </script>

    <!-- Link to Prism JS for highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-log.min.js"></script>

    <!-- Main Visualization Script Placeholder (as plain text) -->
    <script id="main-script-template" type="text/plain">
        // --- Global State Variables ---
let pyodideWorker = null;
let currentOutputContent = null;
let currentOutputType = null; // 'plotly', 'svg', 'message', or 'error'
let workerLogs = []; // Array to store logs from the worker

// Global element references - declared here, assigned in DOMContentLoaded
let loadingIndicator = null;
let errorArea = null;
let plotArea = null;
let exportButtonsDiv = null;

// --- DOM Element References ---
const outputArea = document.getElementById('output-area');
const exportPngButton = document.getElementById('export-png');
const exportSvgButton = document.getElementById('export-svg');
const exportHtmlButton = document.getElementById('export-html');

// Add references for the modal
const viewCodeButton = document.getElementById('view-python-code');
const codeModal = document.getElementById('code-modal');
const closeModalButton = document.getElementById('close-modal');
const pythonCodeDisplay = document.getElementById('python-code-display');

// Add references for the data modal
const viewDataButton = document.getElementById('view-data');
const dataModal = document.getElementById('data-modal');
const closeDataModalButton = document.getElementById('close-data-modal');
const jsonDataDisplay = document.getElementById('json-data-display');

// Add references for the worker log modal
const viewWorkerLogButton = document.getElementById('view-worker-log');
const workerLogModal = document.getElementById('worker-log-modal');
const closeWorkerLogModalButton = document.getElementById('close-worker-log-modal');
const workerLogDisplay = document.getElementById('worker-log-display');
const copyWorkerLogButton = document.getElementById('copy-worker-log-button');

// References for copy buttons
const copyPythonButton = document.getElementById('copy-python-button');
const copyDataButton = document.getElementById('copy-data-button');

// --- Helper Functions ---
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        console.log('Content copied to clipboard');
        // Optional: Add visual feedback (e.g., change button text briefly)
    } catch (err) {
        console.error('Failed to copy content: ', err);
        alert('Failed to copy content to clipboard.');
    }
}

// --- HTML Entity Decoding --- (Added)
function decodeHtmlEntities(text) {
  var textArea = document.createElement('textarea');
  textArea.innerHTML = text;
  return textArea.value;
}

// --- Robust JS String Escaping --- (Restored)
function escapeJsString(str) {
  if (!str) return '';
  // Escape backslashes first, then other characters that could break JS strings or JSON.parse
  return str.replace(/\\/g, '\\\\') // Backslashes
            .replace(/'/g, "\\'")  // Single quotes
            .replace(/"/g, '\\"') // Double quotes (important for JSON parsing within the string)
            .replace(/\n/g, "\\n") // Newlines
            .replace(/\r/g, "\\r") // Carriage returns
            .replace(/\t/g, "\\t") // Tabs
            .replace(/\f/g, "\\f") // Form feeds
            .replace(/\b/g, "\\b") // Backspaces
            .replace(/\u2028/g, "\\u2028") // Line separator
            .replace(/\u2029/g, "\\u2029"); // Paragraph separator
}

// --- UI Update Functions ---
function displayError(message) {
    console.error("Main Thread Error:", message);
    workerLogs.push(`[ERROR] ${message}`); // Add to logs
    if (!loadingIndicator) {
        console.error("Main: Loading indicator not found!");
        return;
    }
    loadingIndicator.style.display = 'none';
    outputArea.style.display = 'none';
    if (!exportButtonsDiv) {
        console.error("Main: Export buttons div not found!");
        return;
    }
    exportButtonsDiv.style.display = 'none';
    // Sanitize or limit error message length if necessary
    if (!errorArea) {
        console.error("Main: Error area not found!");
        return;
    }
    errorArea.textContent = `Error processing visualization:\n${message.substring(0, 1000)}${message.length > 1000 ? '...' : ''}`;
    errorArea.style.display = 'block';
    if (pyodideWorker) {
        pyodideWorker.terminate(); // Clean up worker on error
        pyodideWorker = null;
    }
    viewWorkerLogButton.style.display = 'inline-block'; // Show log button on error
}

function displayOutput(output, type) {
    currentOutputType = type;
    currentOutputContent = output;
    console.log('DisplayOutput received type:', type);
    console.log('DisplayOutput received output content:', output); // Log the received content
    if (!loadingIndicator) {
        console.error("Main: Loading indicator not found!");
        return;
    }
    loadingIndicator.style.display = 'none';
    if (!errorArea) {
        console.error("Main: Error area not found!");
        return;
    }
    errorArea.style.display = 'none';
    outputArea.innerHTML = ''; // Clear previous output/scripts
    try {
        if (type === 'plotly') {
            console.log('Injecting Plotly HTML snippet into outputArea.');
            outputArea.innerHTML = output;

            console.log('Processing scripts within injected HTML to ensure load order...');
            const scripts = outputArea.querySelectorAll('script');
            let plotlyLibraryScriptElement = null;
            const plotlyCallingScriptElements = [];
            const otherScriptElements = [];

            // Create new script elements and categorize them
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                });
                if (oldScript.textContent) {
                    newScript.textContent = oldScript.textContent;
                }

                if (newScript.src && newScript.src.includes('cdn.plot.ly')) {
                    plotlyLibraryScriptElement = newScript; // Assume only one library script
                } else if (newScript.textContent && newScript.textContent.includes('Plotly.newPlot')) {
                    plotlyCallingScriptElements.push(newScript);
                } else {
                    otherScriptElements.push(newScript);
                }
                // Remove the original non-executed script node (for cleanup, avoids double execution if browser behaves unexpectedly)
                oldScript.parentNode.removeChild(oldScript);
            });

            // Execute non-Plotly scripts first
            otherScriptElements.forEach(script => {
                 console.log('Executing non-Plotly script:', script.src || 'inline script');
                 outputArea.appendChild(script);
            });

            // Load Plotly library, then execute calling scripts on load
            if (plotlyLibraryScriptElement) {
                plotlyLibraryScriptElement.onload = () => {
                    console.log('Plotly library loaded via onload. Executing dependent scripts...');
                    plotlyCallingScriptElements.forEach(script => {
                         console.log('Executing Plotly-dependent script:', script.src || 'inline script');
                         outputArea.appendChild(script);
                    });
                    // Explicitly call resize after plot generation attempt
                    setTimeout(() => { // Use setTimeout to ensure it runs after plot is potentially drawn
                        const plotDiv = outputArea.querySelector('.plotly-graph-div');
                        if (plotDiv && typeof Plotly !== 'undefined') {
                            console.log('Attempting Plotly resize on:', plotDiv.id);
                            Plotly.Plots.resize(plotDiv);
                        }
                    }, 100); // Adjust delay if needed
                };
                plotlyLibraryScriptElement.onerror = () => {
                     console.error('Failed to load Plotly library script!');
                     displayError('Failed to load Plotly library. Cannot render visualization.');
                };
                 console.log('Appending Plotly library script (will load async):', plotlyLibraryScriptElement.src);
                 outputArea.appendChild(plotlyLibraryScriptElement);
            } else {
                // If no library found, but calling scripts exist, it's an error state
                if (plotlyCallingScriptElements.length > 0) {
                     console.error('Plotly calling script found, but no Plotly library script detected!');
                     displayError('Plotly library script missing in generated output. Cannot render visualization.');
                } else {
                     console.log('No Plotly library script found, executing remaining scripts directly (if any).');
                     plotlyCallingScriptElements.forEach(script => { // Should be empty in this case, but just in case
                         console.log('Executing script (no library dependency assumed):', script.src || 'inline script');
                         outputArea.appendChild(script);
                     });
                }
            }

        } else if (type === 'svg') {
            // Directly inject SVG content (no scripts expected here)
            outputArea.innerHTML = output;
        } else {
            outputArea.textContent = "Unsupported output type.";
        }
        outputArea.style.display = 'block';
        if (!exportButtonsDiv) {
            console.error("Main: Export buttons div not found!");
            return;
        }
        exportButtonsDiv.style.display = 'block';
        updateExportButtonStates(type);
    } catch (e) {
        displayError(`Error rendering output: ${e.message}`);
    }
}

function updateExportButtonStates(type) {
    // Enable/disable based on output type and library capabilities
    const hasPlotly = typeof Plotly !== 'undefined' && typeof Plotly.toImage === 'function';
    exportPngButton.disabled = !(type === 'plotly_json' && hasPlotly);
    exportSvgButton.disabled = !(type === 'plotly_json' && hasPlotly);
    exportHtmlButton.disabled = !(type === 'plotly_json' || type === 'svg'); // Enable if we have Plotly JSON or raw SVG
}

function downloadFile(filename, content, mimeType) {
    console.log(`Attempting to download: ${filename}, Mime: ${mimeType}, Content starts with: ${content.substring(0, 30)}...`);
    const link = document.createElement('a');
    link.download = filename;

    if (typeof content === 'string' && content.startsWith('data:')) {
        // Handle Data URLs (from Plotly.toImage for PNG/SVG)
        console.log("Content is a Data URL. Setting href directly.");
        link.href = content;
    } else {
        // Handle other content (like HTML export) by creating a Blob
        console.log("Content is not a Data URL. Creating Blob URL.");
        const blob = new Blob([content], { type: mimeType });
        link.href = URL.createObjectURL(blob);
    }

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Clean up Blob URL if one was created
    if (!(typeof content === 'string' && content.startsWith('data:')) && link.href) {
         URL.revokeObjectURL(link.href);
         console.log("Blob URL revoked.");
    }
}

// --- Worker Setup and Communication --- ---
function initializePyodideWorker(workerScriptContent, pythonScriptContent, inputData) {
    if (pyodideWorker) {
        return; // Already initialized or initializing
    }
    workerLogs = ['[INFO] Initializing Worker...']; // Reset logs
    viewWorkerLogButton.style.display = 'none'; // Hide initially

    try {
        // Create a Blob from the worker script string
        const blob = new Blob([workerScriptContent], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);

        console.log("Main: Creating Worker from Blob URL...");
        pyodideWorker = new Worker(workerUrl);

        // --- Worker Message Handling ---
        pyodideWorker.onmessage = (event) => {
            const { type, message, data } = event.data;
            console.log("Main: Received message from worker:", event.data);
            workerLogs.push(`[WORKER ${type.toUpperCase()}] ${message || data}`); // Log status/errors/results
            viewWorkerLogButton.style.display = 'inline-block'; // Show log button once worker communicates

            if (type === 'status') {
                if (!loadingIndicator) {
                    console.error("Main: Loading indicator not found!");
                    return;
                }
                loadingIndicator.textContent = message; // Update loading status
            } else if (type === 'result') {
                console.log("Main: Received plot JSON from worker.");
                // Assuming Plotly output for now based on python script
                // The Python script returns JSON, Plotly.react needs this JSON
                try {
                    const plotJson = JSON.parse(data); // Correctly parse the full JSON
                    const plotData = plotJson.data;    // Declare with const
                    const plotLayout = plotJson.layout; // Declare with const

                    // Log the data and layout being passed to Plotly
                    console.log("Plot Data:", JSON.stringify(plotData));
                    console.log("Plot Layout:", JSON.stringify(plotLayout));

                    // --- Render directly into the existing #plot-area --- 
                    console.log("Main: Preparing plot area.");
                    if (!loadingIndicator) {
                        console.error("Main: Loading indicator not found!");
                        return;
                    }
                    loadingIndicator.style.display = 'none'; // Hide loading
                    if (!errorArea) {
                        console.error("Main: Error area not found!");
                        return;
                    }
                    errorArea.style.display = 'none'; // Hide error area
                    // outputArea.innerHTML = ''; // REMOVED: Don't clear the container holding #plot-area
                    
                    // Use the global plotArea reference (should be non-null if DOM loaded)
                    if (!plotArea) {
                         throw new Error("Plot area element (#plot-area) not found.");
                    }
                    plotArea.innerHTML = ''; // Clear previous plot content inside #plot-area
                    plotArea.style.display = 'block'; // Make the dedicated plot area visible

                    Plotly.newPlot('plot-area', plotData, plotLayout, { responsive: true }); // Target the existing #plot-area
                    console.log("Main: Plotly plot rendered into #plot-area.");

                    currentOutputContent = data; // Store the JSON data for potential export
                    currentOutputType = 'plotly_json'; // Set type for export logic

                } catch (e) {
                    console.error("Main: Error parsing or rendering Plotly JSON", e);
                    displayError(`Failed to render plot: ${e.message}`);
                }
                 // Update buttons after rendering attempt
                 if (!exportButtonsDiv) {
                    console.error("Main: Export buttons div not found!");
                    return;
                 }
                 exportButtonsDiv.style.display = 'block';
                 updateExportButtonStates(currentOutputType);
            } else if (type === 'error') {
                console.error("Main: Received error from worker:", message);
                displayError(`Worker error: ${message}`);
            }
        };

        // --- Worker Error Handling ---
        pyodideWorker.onerror = (error) => {
            console.error("Main: Worker error occurred:", error);
            workerLogs.push(`[ERROR] Worker script error: ${error.message} at ${error.filename}:${error.lineno}`);
            displayError(`Worker script error: ${error.message}`);
            viewWorkerLogButton.style.display = 'inline-block'; // Show log button on error
            // No need to terminate here, displayError already handles it
        };

        // Clean up the Blob URL once the worker is created (or if creation fails)
        // Though technically it's safe to revoke immediately after worker creation starts
        URL.revokeObjectURL(workerUrl);

        // Send the initial task to the worker
        console.log("Main: Sending initial task to worker...");
        pyodideWorker.postMessage({
            pythonScript: pythonScriptContent,
            inputData: inputData
        });

    } catch (initError) {
         console.error("Main: Failed to create Worker:", initError);
         displayError(`Failed to initialize visualization engine: ${initError.message}`);
         workerLogs.push(`[ERROR] Failed to create Worker: ${initError.message}`);
         viewWorkerLogButton.style.display = 'inline-block';
    }
}

// --- Initialization --- (Modified)
document.addEventListener('DOMContentLoaded', () => {
    // --- Assign global element references --- 
    loadingIndicator = document.getElementById('loading-indicator');
    errorArea = document.getElementById('error-area');
    plotArea = document.getElementById('plot-area');
    exportButtonsDiv = document.getElementById('export-buttons');

    // --- Local references for modals and buttons (used only within this scope) ---
    const codeModal = document.getElementById('code-modal');
    const dataModal = document.getElementById('data-modal');
    const closeModalButton = document.getElementById('close-modal');
    const pythonCodeDisplay = document.getElementById('python-code-display');
    const viewDataButton = document.getElementById('view-data');
    const jsonDataDisplay = document.getElementById('json-data-display');
    const closeDataModalButton = document.getElementById('close-data-modal');
    const viewWorkerLogButton = document.getElementById('view-worker-log');
    const workerLogModal = document.getElementById('worker-log-modal');
    const closeWorkerLogModalButton = document.getElementById('close-worker-log-modal');
    const workerLogDisplay = document.getElementById('worker-log-display');
    const copyWorkerLogButton = document.getElementById('copy-worker-log-button');
    const copyPythonButton = document.getElementById('copy-python-button');
    const copyDataButton = document.getElementById('copy-data-button');

    // Read embedded content
    let jsonData = null;
    let pythonScriptContent = null;
    let workerScriptContent = null;

    try {
        // Read worker script from its designated template tag
        const workerScriptElement = document.getElementById('worker-script-template');
        if (!workerScriptElement) throw new Error("Worker script template element not found.");
        workerScriptContent = decodeHtmlEntities(workerScriptElement.textContent); // Decode

        // Read Python script from its template tag
        const pythonScriptElement = document.getElementById('python-script-template');
        if (!pythonScriptElement) throw new Error("Python script template element not found.");
        pythonScriptContent = decodeHtmlEntities(pythonScriptElement.textContent); // Decode

        // Read JSON data from its template tag
        const jsonDataElement = document.getElementById('input-data');
        if (!jsonDataElement) throw new Error("JSON data template element not found.");
        const rawJsonData = decodeHtmlEntities(jsonDataElement.textContent); // Decode

        // Parse JSON data
        if (!rawJsonData) {
            console.warn("JSON data in template was empty. Defaulting to {}.");
            jsonData = {}; // Default to empty object
        } else {
             try {
                 jsonData = JSON.parse(rawJsonData);
             } catch (parseError) {
                 throw new Error(`Failed to parse JSON data from template: ${parseError.message}`);
             }
        }

        if (!pythonScriptContent || !workerScriptContent) { 
             throw new Error("Embedded worker script or Python script content is empty.");
        }

        // Start the worker initialization process
        initializePyodideWorker(workerScriptContent, pythonScriptContent, jsonData);

    } catch (e) {
        displayError(`Initialization failed: ${e.message}`);
        return; // Stop further setup if essential parts are missing
    }


    // --- Export Button Handlers (Modified for Plotly JSON) ---
     exportPngButton.addEventListener('click', () => {
         // Requires Plotly.toImage - make sure Plotly object is available
         const plotDiv = outputArea.querySelector('#plot-area'); // Target the specific div
         if (plotDiv && typeof Plotly !== 'undefined') {
            Plotly.toImage(plotDiv, { format: 'png', height: 600, width: 800 })
                .then(dataUrl => downloadFile('visualization.png', dataUrl, 'image/png'))
                .catch(err => {
                    console.error('Plotly PNG export failed:', err);
                    alert('Failed to export PNG.');
                });
         } else {
             alert("PNG export requires a rendered Plotly chart.");
         }
     });

     exportSvgButton.addEventListener('click', () => {
         const plotDiv = outputArea.querySelector('#plot-area');
         if (plotDiv && typeof Plotly !== 'undefined') {
             Plotly.toImage(plotDiv, { format: 'svg', height: 600, width: 800 })
                .then(dataUrl => downloadFile('visualization.svg', dataUrl, 'image/svg+xml'))
                .catch(err => {
                    console.error('Plotly SVG export failed:', err);
                    alert('Failed to export SVG.');
                });
         } else {
             alert('SVG export requires a rendered Plotly chart.');
         }
     });

     exportHtmlButton.addEventListener('click', () => {
         if (currentOutputType === 'plotly_json' && currentOutputContent) {
            try {
                // Parse the stored JSON string to get data/layout objects
                const plotJson = JSON.parse(currentOutputContent);
                const plotData = plotJson.data;
                const plotLayout = plotJson.layout;

                // Convert data/layout objects back to JSON strings. These are what we need.
                const plotDataString = JSON.stringify(plotData);
                const plotLayoutString = JSON.stringify(plotLayout);

                // Build HTML content. Embed the raw JSON strings directly into the script.
                // Replace any potential closing script tags within the JSON to prevent breaking the HTML.
                const safePlotDataString = plotDataString.replace(/<\/script>/gi, '<\\/script>');
                const safePlotLayoutString = plotLayoutString.replace(/<\/script>/gi, '<\\/script>');

                const htmlContent = "<!DOCTYPE html>\n"
                                + "<html>\n"
                                + "<head>\n"
                                + "    <meta charset=\"utf-8\" />\n"
                                + "    <title>Exported Plotly Chart</title>\n"
                                // Use the same Plotly version as the main page
                                + "    <script src='https://cdn.plot.ly/plotly-2.32.0.min.js'><\/script>\n"
                                + "</head>\n"
                                + "<body>\n"
                                + "    <div id='plotly-div'></div>\n"
                                + "    <script>\n"
                                + "        try {\n"
                                + "            var data = " + safePlotDataString + ";\n"
                                + "            var layout = " + safePlotLayoutString + ";\n"
                                + "            Plotly.newPlot('plotly-div', data, layout);\n"
                                + "        } catch (e) { \n"
                                + "            console.error('Error rendering exported plot:', e); \n"
                                + "            document.body.innerHTML = '<pre>Error rendering plot: ' + e.message + '</pre>'; \n"
                                + "        } \n"
                                + "    <\/script>\n"
                                + "</body>\n"
                                + "</html>";

                downloadFile('visualization.html', htmlContent, 'text/html');
            } catch (e) {
                console.error("Error creating export HTML:", e);
                alert('Failed to create HTML export from plot data.');
            }
         } else {
            alert('HTML export requires rendered Plotly chart data.');
         }
     });

     // --- View Code Button Handler (Modified) ---
     viewCodeButton.addEventListener('click', () => {
         if (pythonScriptContent) {
             pythonCodeDisplay.textContent = pythonScriptContent.trim(); // Display the code
             Prism.highlightElement(pythonCodeDisplay); // Apply syntax highlighting
             codeModal.style.display = "block"; // Show the modal
         } else {
             alert("Could not find the embedded Python script content.");
         }
     });

     // --- View Data Button Handler (Modified) ---
     viewDataButton.addEventListener('click', () => {
         try {
             const jsonDataString = JSON.stringify(jsonData, null, 2); // Pretty print JSON
             if (jsonDataString) {
                 jsonDataDisplay.textContent = jsonDataString; // Display the data
                 Prism.highlightElement(jsonDataDisplay); // Apply syntax highlighting
                 dataModal.style.display = "block"; // Show the modal
             } else {
                 alert("Could not format the embedded JSON data.");
             }
         } catch (e) {
             alert(`Error formatting JSON data: ${e.message}`);
         }
     });

     // --- View Worker Log Button Handler ---
     viewWorkerLogButton.addEventListener('click', () => {
         workerLogDisplay.textContent = workerLogs.join('\n'); // Display logs
         Prism.highlightElement(workerLogDisplay); // Apply syntax highlighting
         workerLogModal.style.display = "block"; // Show the modal
     });

     // --- Modal Close Button Handlers ---
     closeModalButton.addEventListener('click', () => {
         codeModal.style.display = "none"; // Hide the modal
     });

     closeDataModalButton.addEventListener('click', () => {
         dataModal.style.display = "none"; // Hide the modal
     });

     closeWorkerLogModalButton.addEventListener('click', () => {
         workerLogModal.style.display = "none"; // Hide the modal
     });

     // --- Copy Button Handlers ---
     copyPythonButton.addEventListener('click', () => {
        if (pythonScriptContent) copyToClipboard(pythonScriptContent.trim());
     });

     copyDataButton.addEventListener('click', () => {
        try {
            const jsonDataString = JSON.stringify(jsonData, null, 2);
            if (jsonDataString) copyToClipboard(jsonDataString);
        } catch (e) { alert('Failed to copy JSON data.'); }
     });

     copyWorkerLogButton.addEventListener('click', () => {
        if(workerLogs.length > 0) copyToClipboard(workerLogs.join('\n'));
     });

    // Initialize Prism for syntax highlighting if modals are used
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }

    // --- Plot Resizing Logic --- 
    // Reusable function to update Plotly layout based on plotArea size
    const updatePlotLayout = () => {
        // Ensure plotArea is valid, visible, Plotly exists, and the plot has been rendered inside
        if (plotArea && plotArea.offsetParent !== null && typeof Plotly !== 'undefined' && plotArea.querySelector('.plotly-graph-div')) {
            try {
                const newWidth = plotArea.clientWidth;
                const newHeight = plotArea.clientHeight;
                // Defer Plotly updates slightly using setTimeout to allow browser layout reflow
                setTimeout(() => {
                    if (newWidth > 0 && newHeight > 0) {
                        Plotly.relayout(plotArea, {
                            width: newWidth,
                            height: newHeight,
                            'xaxis.autorange': true,
                            'yaxis.autorange': true
                        });
                        Plotly.Plots.resize(plotArea);
                    } else {
                    }
                }, 0); // Use setTimeout with 0 delay
            } catch (e) {
                console.error('Error during Plotly relayout:', e);
            }
        } else {
        }
    };

    // Add resize handler for Plotly chart (for WINDOW resize)
    window.addEventListener('resize', updatePlotLayout);

    // Add ResizeObserver for the outputArea (for ELEMENT resize)
    if (window.ResizeObserver && outputArea) {
        const resizeObserver = new ResizeObserver(entries => {
            // We typically only observe one element here
            for (let entry of entries) {
                updatePlotLayout();
            }
        });
        resizeObserver.observe(outputArea);
    } else {
        console.warn('ResizeObserver not supported or outputArea not found.');
    }
});

    </script>

    <!-- Bootstrap script to execute the main script -->
    <script type="text/javascript">
        try {
            const mainScriptContent = document.getElementById('main-script-template')?.textContent;
            if (mainScriptContent) {
                // Execute the script content in the global scope
                new Function(mainScriptContent)();
            } else {
                throw new Error("Main script template content not found.");
            }
        } catch (e) {
            console.error("Failed to execute main visualization script:", e);
            const errorArea = document.getElementById('error-area');
            if (errorArea) {
                errorArea.textContent = `Fatal Error: Could not run visualization script. ${e.message}`;
                errorArea.style.display = 'block';
                document.getElementById('loading-indicator').style.display = 'none'; // Hide loading
            }
        }
    </script>

</body>
</html>
